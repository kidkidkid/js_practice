<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>requestAnimation</title>
</head>
<body>
<canvas width="800" height="600" id="animation"></canvas>
<canvas width="800" height="600" id="animation2" style="margin-left:200px;"></canvas>
<button style="position:absolute; top: 40px; left: 840px;width: 60px;height: 40px;font-size: 16px;">Pause</button>
<script>
    window.requestNextAnimation = (function () {
        return window.requestAnimationFrame ||
                window.webkitRequestAnimationFrame ||
                window.mozRequestAnimationFrame ||
                window.msRequestAnimationFrame ||
                function (callback) {
                    var self = this,
                        start,
                        finish;
                    setTimeout(function () {
                        start = +new Date();
                        callback(start);
                        finish = +new Date();
                        self.timeout = 1000 / 60 - (finish - start); //如果没有内置函数 则返回一个类似的函数 保证每秒60帧的速率
                    }, self.timeout)
                };
    }());

    (function () {
        var context = document.getElementById("animation").getContext("2d"),
            discs = [
                {
                    x: 150,
                    y: 250,
                    velocityX: -3.2,
                    velocityY: 3.5,
                    radius: 25,
                    innerColor: 'rgba(255, 255, 0, 1)',
                    middleColor: 'rgba(255, 255, 0, 0.7)',
                    outerColor: 'rgba(255, 255, 0, 0.5)',
                    strokeStyle: "grey"
                },
                {
                    x: 50,
                    y: 150,
                    velocityX: 2.2,
                    velocityY: 2.5,
                    radius: 25,
                    innerColor: 'rgba(100, 145, 230, 1)',
                    middleColor: 'rgba(100, 145, 230, 0.7)',
                    outerColor: 'rgba(100, 145, 230, 0.5)',
                    strokeStyle: "blue"
                },
                {
                    x: 150,
                    y: 70,
                    velocityX: 1.2,
                    velocityY: 1.5,
                    radius: 25,
                    innerColor: 'rgba(255, 0, 0, 1)',
                    middleColor: 'rgba(255, 0, 0, 0.7)',
                    outerColor: 'rgba(255, 0, 0, 0.5)',
                    strokeStyle: "orange"
                },
                {
                    x: 250,
                    y: 70,
                    velocityX: -1.2,
                    velocityY: 1.5,
                    radius: 25,
                    innerColor: 'rgba(255, 0, 0, 1)',
                    middleColor: 'rgba(255, 0, 0, 0.7)',
                    outerColor: 'rgba(255, 0, 0, 0.5)',
                    strokeStyle: "orange"
                },
                {
                    x: 250,
                    y: 170,
                    velocityX: 2.2,
                    velocityY: 1.5,
                    radius: 25,
                    innerColor: 'rgba(255, 0, 0, 1)',
                    middleColor: 'rgba(255, 0, 0, 0.7)',
                    outerColor: 'rgba(255, 0, 0, 0.5)',
                    strokeStyle: "orange"
                },
                {
                    x: 350,
                    y: 270,
                    velocityX: 1.2,
                    velocityY: -1.5,
                    radius: 25,
                    innerColor: 'rgba(255, 0, 0, 1)',
                    middleColor: 'rgba(255, 0, 0, 0.7)',
                    outerColor: 'rgba(255, 0, 0, 0.5)',
                    strokeStyle: "orange"
                },
                {
                    x: 240,
                    y: 90,
                    velocityX: -3.2,
                    velocityY: 1.5,
                    radius: 25,
                    innerColor: 'rgba(255, 0, 0, 1)',
                    middleColor: 'rgba(255, 0, 0, 0.7)',
                    outerColor: 'rgba(255, 0, 0, 0.5)',
                    strokeStyle: "orange"
                },
                {
                    x: 350,
                    y: 90,
                    velocityX: 1.2,
                    velocityY: 2.5,
                    radius: 25,
                    innerColor: 'rgba(255, 0, 0, 1)',
                    middleColor: 'rgba(255, 0, 0, 0.7)',
                    outerColor: 'rgba(255, 0, 0, 0.5)',
                    strokeStyle: "orange"
                },
                {
                    x: 150,
                    y: 370,
                    velocityX: 1.8,
                    velocityY: 1.7,
                    radius: 25,
                    innerColor: 'rgba(255, 0, 0, 1)',
                    middleColor: 'rgba(255, 0, 0, 0.7)',
                    outerColor: 'rgba(255, 0, 0, 0.5)',
                    strokeStyle: "orange"
                }
            ],
            pause = false,
            lastTime = 0,
            lastUpdateTime = 0,
            lastFPS = 0;

           function drawDisc() {
               for(var i = 0; i < discs.length; i++) {
                   var temp = discs[i];
                   context.save();
                   context.beginPath();
                   context.arc(temp.x, temp.y, temp.radius, 0, Math.PI * 2);
                   context.strokeStyle = temp.strokeStyle;
                   var gradient = context.createRadialGradient(temp.x, temp.y, 0, temp.x, temp.y, temp.radius);
                   gradient.addColorStop(0, temp.innerColor);
                   gradient.addColorStop(0.5, temp.middleColor);
                   gradient.addColorStop(1, temp.outerColor);
                   context.fillStyle = gradient;
                   context.fill();
                   context.stroke();
                   context.restore();
               }
           }

           function animation(time) {
               context.clearRect(0, 0, context.canvas.width, context.canvas.height);
               for(var i = 0; i < discs.length; i++) {
                   var temp = discs[i];
                   if(temp.x + temp.velocityX - temp.radius < 0 || temp.x + temp.velocityX + temp.radius > context.canvas.width) {
                       temp.velocityX = -temp.velocityX;
                   }
                   if(temp.y + temp.velocityY - temp.radius < 0 || temp.y + temp.velocityY + temp.radius > context.canvas.height) {
                       temp.velocityY = -temp.velocityY;
                   }
                   temp.x += temp.velocityX;
                   temp.y += temp.velocityY;
               }
               drawDisc();

               context.save();
               context.font = "bold 30px arial";
               if(time - lastUpdateTime > 1000) {
                    lastUpdateTime = time;
                    lastFPS = calculateFPS();
               } else {
                   calculateFPS();
               }
               context.fillText("FPS: " + lastFPS.toFixed(), 40, 40);
               context.restore();
               if(!pause) window.requestNextAnimation(animation);
           }
           
           function startPlay() {
               window.requestNextAnimation(animation);
           }

           function calculateFPS() {
                var now = +new Date(),
                    fps = 1000 / (now - lastTime);
                lastTime = now;
                return fps;
           }
           
           document.getElementsByTagName("button")[0].onclick = function () {
               pause = true;
           };

           startPlay();
    }());

    (function () {
        var context = document.getElementById("animation2").getContext("2d"),
            discs = [
                {
                    x: 150,
                    y: 250,
                    velocityX: -3.2,
                    velocityY: 3.5,
                    radius: 25,
                    innerColor: 'rgba(255, 255, 0, 1)',
                    middleColor: 'rgba(255, 255, 0, 0.7)',
                    outerColor: 'rgba(255, 255, 0, 0.5)',
                    strokeStyle: "grey"
                },
                {
                    x: 50,
                    y: 150,
                    velocityX: 2.2,
                    velocityY: 2.5,
                    radius: 25,
                    innerColor: 'rgba(100, 145, 230, 1)',
                    middleColor: 'rgba(100, 145, 230, 0.7)',
                    outerColor: 'rgba(100, 145, 230, 0.5)',
                    strokeStyle: "blue"
                },
                {
                    x: 150,
                    y: 70,
                    velocityX: 1.2,
                    velocityY: 1.5,
                    radius: 25,
                    innerColor: 'rgba(255, 0, 0, 1)',
                    middleColor: 'rgba(255, 0, 0, 0.7)',
                    outerColor: 'rgba(255, 0, 0, 0.5)',
                    strokeStyle: "orange"
                },
                {
                    x: 250,
                    y: 70,
                    velocityX: -1.2,
                    velocityY: 1.5,
                    radius: 25,
                    innerColor: 'rgba(255, 0, 0, 1)',
                    middleColor: 'rgba(255, 0, 0, 0.7)',
                    outerColor: 'rgba(255, 0, 0, 0.5)',
                    strokeStyle: "orange"
                },
                {
                    x: 250,
                    y: 170,
                    velocityX: 2.2,
                    velocityY: 1.5,
                    radius: 25,
                    innerColor: 'rgba(255, 0, 0, 1)',
                    middleColor: 'rgba(255, 0, 0, 0.7)',
                    outerColor: 'rgba(255, 0, 0, 0.5)',
                    strokeStyle: "orange"
                },
                {
                    x: 350,
                    y: 270,
                    velocityX: 1.2,
                    velocityY: -1.5,
                    radius: 25,
                    innerColor: 'rgba(255, 0, 0, 1)',
                    middleColor: 'rgba(255, 0, 0, 0.7)',
                    outerColor: 'rgba(255, 0, 0, 0.5)',
                    strokeStyle: "orange"
                },
                {
                    x: 240,
                    y: 90,
                    velocityX: -3.2,
                    velocityY: 1.5,
                    radius: 25,
                    innerColor: 'rgba(255, 0, 0, 1)',
                    middleColor: 'rgba(255, 0, 0, 0.7)',
                    outerColor: 'rgba(255, 0, 0, 0.5)',
                    strokeStyle: "orange"
                },
                {
                    x: 350,
                    y: 90,
                    velocityX: 1.2,
                    velocityY: 2.5,
                    radius: 25,
                    innerColor: 'rgba(255, 0, 0, 1)',
                    middleColor: 'rgba(255, 0, 0, 0.7)',
                    outerColor: 'rgba(255, 0, 0, 0.5)',
                    strokeStyle: "orange"
                },
                {
                    x: 150,
                    y: 370,
                    velocityX: 1.8,
                    velocityY: 1.7,
                    radius: 25,
                    innerColor: 'rgba(255, 0, 0, 1)',
                    middleColor: 'rgba(255, 0, 0, 0.7)',
                    outerColor: 'rgba(255, 0, 0, 0.5)',
                    strokeStyle: "orange"
                }
            ],
            lastTime = 0,
            lastUpdateTime = 0,
            lastFPS = 0,
            lastRunTime = 0;

        function drawDisc() {
            for(var i = 0; i < discs.length; i++) {
                var temp = discs[i];
                context.save();
                context.beginPath();
                context.arc(temp.x, temp.y, temp.radius, 0, Math.PI * 2);
                context.strokeStyle = temp.strokeStyle;
                var gradient = context.createRadialGradient(temp.x, temp.y, 0, temp.x, temp.y, temp.radius);
                gradient.addColorStop(0, temp.innerColor);
                gradient.addColorStop(0.5, temp.middleColor);
                gradient.addColorStop(1, temp.outerColor);
                context.fillStyle = gradient;
                context.fill();
                context.stroke();
                context.restore();
            }
        }

        //requestAnimation(callback) 会给callback传入一个time参数 chrome10不会 有一个bug
        //这个参数不是从19XX开始的时间戳 而是从调用开始的
        function timeBased_animation(time) {
            context.clearRect(0, 0, context.canvas.width, context.canvas.height);
            var elapsedTime = time  - lastRunTime;
            for(var i = 0; i < discs.length; i++) {
                var temp = discs[i];
                var delt_x = temp.velocityX * elapsedTime / 1000 * 60;
                var delt_y = temp.velocityY * elapsedTime / 1000 * 60;
                if(temp.x + delt_x - temp.radius < 0 || temp.x + delt_x + temp.radius > context.canvas.width) {
                    temp.velocityX = -temp.velocityX;
                }
                if(temp.y + delt_y - temp.radius < 0 || temp.y + delt_y + temp.radius > context.canvas.height) {
                    temp.velocityY = -temp.velocityY;
                }
                temp.x += delt_x;
                temp.y += delt_y;
                lastRunTime = time;
            }
            drawDisc();

            context.save();
            context.font = "bold 30px arial";
            if(+new Date() - lastUpdateTime > 1000) {
                lastUpdateTime = +new Date();
                lastFPS = calculateFPS();
            } else {
                calculateFPS();
            }
            context.fillText("FPS: " + lastFPS.toFixed(), 40, 40);
            context.restore();
           window.requestNextAnimation(timeBased_animation);
        }

        function startPlay() {
            window.requestNextAnimation(timeBased_animation);
        }

        function calculateFPS() {
            var now = +new Date(),
                fps = 1000 / (now - lastTime);
            lastTime = now;
            return fps;
        }

        startPlay();
    }());
</script>
</body>
</html>